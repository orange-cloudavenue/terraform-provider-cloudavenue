# --------------------------------------------------------------
# WARNING: This file is managed by centralized sync management system.
# Do not edit this file directly, your changes will be overwritten.
# See https://github.com/orange-cloudavenue/workflows for more information.
# --------------------------------------------------------------
name: Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag version number (Eg: v0.1.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  pre-check:
    name: Pre-Check
    uses: orange-cloudavenue/workflows/.github/workflows/tag_check-tag.yml@main
    with:
      tag: ${{ github.event.inputs.tag }}
    secrets:
      TOKEN: ${{ secrets.CHANGELOG_PAT }}

  golang-ci-lint:
    needs: [pre-check]
    name: "Lint"
    uses: orange-cloudavenue/workflows/.github/workflows/go_golangci-lint.yml@main
  tests:
    needs: [pre-check]
    name: "Unit Tests"
    uses: orange-cloudavenue/workflows/.github/workflows/go_unit-test-tf-provider.yml@main
    secrets:
      CLOUDAVENUE_ORG: ${{ secrets.CLOUDAVENUE_ORG }}
      CLOUDAVENUE_USER: ${{ secrets.CLOUDAVENUE_USER }}
      CLOUDAVENUE_PASSWORD: ${{ secrets.CLOUDAVENUE_PASSWORD }}
      CLOUDAVENUE_VDC: ${{ secrets.CLOUDAVENUE_VDC }}
  tag:
    needs: [golang-ci-lint, tests]

    name: Tag
    uses: orange-cloudavenue/workflows/.github/workflows/tag_create-tag.yml@main
    with:
      tag: ${{ github.event.inputs.tag }}
    secrets:
      TOKEN: ${{ secrets.CHANGELOG_PAT }}

  release-notes:
    needs: [tag]
    name: Release Notes
    uses: orange-cloudavenue/workflows/.github/workflows/release_generate-release-note.yml@main
    with:
      tag: ${{ github.event.inputs.tag }}
    secrets:
      TOKEN: ${{ secrets.CHANGELOG_PAT }}

  make-release:
    needs: [release-notes]
    uses: orange-cloudavenue/workflows/.github/workflows/release_publish-terraform-provider.yml@main
    with:
      tag: ${{ github.event.inputs.tag }}
      artifact-name: ${{ needs.release-notes.outputs.artifact-name }}
    secrets:
      TOKEN: ${{ secrets.CHANGELOG_PAT }}
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      PASSPHRASE: ${{ secrets.PASSPHRASE }}
      METRICS_TARGET: ${{ secrets.METRICS_TARGET }}
      METRICS_TOKEN: ${{ secrets.METRICS_TOKEN }} 

  changelog-newversion:
    needs: [make-release]
    uses: orange-cloudavenue/workflows/.github/workflows/changelog_generate-new-version.yml@main
    with:
      tag: ${{ github.event.inputs.tag }}
    secrets:
      TOKEN: ${{ secrets.CHANGELOG_PAT }}
  
  publish-doc:
    needs: [make-release]
    name: "Publish Documentation"
    uses: orange-cloudavenue/workflows/.github/workflows/doc_publish.yml@main