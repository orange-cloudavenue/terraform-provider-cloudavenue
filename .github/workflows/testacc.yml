name: Tests Acceptance

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ "main" ]

jobs:
  build:
    name: Build
    runs-on: ubuntu-22.04
    if: github.event.issue.author_association == 'OWNER' &&
      github.event.issue.author_association == 'MEMBER' &&
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/testacc ')
    steps:
    - name: Extract Command
      id: command
      uses: xt0rted/slash-command-action@v2
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        command: testacc
        reaction: "true"
        reaction-type: "rocket"
        allow-edits: "false"
        permission-level: write
    - uses: actions/checkout@v3 # v3.5.0
    - uses: actions/setup-go@v4.0.1 # v4.0.0
      with:
        go-version-file: 'go.mod'
    - run: go mod download
    - run: go build -v .

  test:
    name: Terraform Provider Acceptance Tests
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        terraform:
          - '1.3.*'
    steps:
      - uses: actions/checkout@v3 # v3.5.0
      - uses: actions/setup-go@v4.0.1 # v4.0.0
        with:
          go-version-file: 'go.mod'
      - uses: hashicorp/setup-terraform@633666f66e0061ca3b725c73b2ec20cd13a8fdd1 # v2.0.3
        with:
          terraform_version: ${{ matrix.terraform }}
          terraform_wrapper: false
      - run: go mod download
      - env:
          TF_ACC: "1"
          CLOUDAVENUE_ORG: ${{ secrets.CLOUDAVENUE_ORG }}
          CLOUDAVENUE_USER: ${{ secrets.CLOUDAVENUE_USER }}
          CLOUDAVENUE_PASSWORD: ${{ secrets.CLOUDAVENUE_PASSWORD }}
        run: |
          TEST_NAME=$(echo ${{ github.event.comment.body }} | cut -d " " -f2)
          CATEGORY=$(echo $TEST_NAME | sed -r 's/^TestAcc([A-Z][a-z]*).*$/\1/' | tr '[:upper:]' '[:lower:]')
          go test ./internal/tests/$CATEGORY -run $TEST_NAME
        timeout-minutes: 10
